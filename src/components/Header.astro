---
import HeaderLink from './HeaderLink.astro';
import SocialLinks from './SocialLinks.astro';
import { SITE_TITLE, FEATURES } from '../consts';
---

<header>
	<nav>
		<h2><a href="/">{SITE_TITLE}</a></h2>
		<button class="menu-toggle" aria-label="メニューを開く" aria-expanded="false">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<line x1="3" y1="6" x2="21" y2="6"></line>
				<line x1="3" y1="12" x2="21" y2="12"></line>
				<line x1="3" y1="18" x2="21" y2="18"></line>
			</svg>
		</button>
		<div class="nav-content">
			<div class="internal-links">
				<HeaderLink href="/">Home</HeaderLink>
				<HeaderLink href="/blog">Blog</HeaderLink>
				{FEATURES.TAGS_ENABLED && <HeaderLink href="/tags">Tags</HeaderLink>}
				{FEATURES.ARCHIVE_ENABLED && <HeaderLink href="/archive/monthly">Archive</HeaderLink>}
				<HeaderLink href="/about">About</HeaderLink>
			</div>
			<SocialLinks />
		</div>
	</nav>
</header>

<script>
	// 遅延初期化でパフォーマンス改善
	let headerInitialized = false;
	function initializeHeader() {
		if (headerInitialized) return;
		headerInitialized = true;
		
		const m = document.querySelector('.menu-toggle'), n = document.querySelector('.nav-content');
		if (!m || !n) return;
		
		const close = () => {
			n.classList.remove('is-open');
			m.setAttribute('aria-expanded', 'false');
			m.setAttribute('aria-label', 'メニューを開く');
		};
		
		// イベント最小化
		m.onclick = () => {
			const o = n.classList.toggle('is-open');
			m.setAttribute('aria-expanded', String(o));
			m.setAttribute('aria-label', o ? 'メニューを閉じる' : 'メニューを開く');
		};
		
		// パッシブリスナーとデバウンス
		let t;
		addEventListener('resize', () => { clearTimeout(t); t = setTimeout(close, 100); }, {passive: true});
		addEventListener('click', e => !m.contains(e.target) && !n.contains(e.target) && close());
		addEventListener('keydown', e => e.key === 'Escape' && n.classList.contains('is-open') && (close(), m.focus()));
	}
	
	// モバイル時のみ初期化
	if (innerWidth <= 768) initializeHeader();
	else addEventListener('resize', () => innerWidth <= 768 && initializeHeader(), {once: true, passive: true});
</script>

<style>
	header {
		margin: 0;
		padding: 0 1em;
		background: var(--primary-background);
		box-shadow: 0 2px 8px oklch(12% 0.02 260 / 0.05);
		position: relative;
		z-index: 999;
	}
	h2 {
		margin: 0;
		font-size: 1em;
	}

	h2 a,
	h2 a.active {
		text-decoration: none;
		transition: opacity 0.2s ease;
	}
	
	h2 a:hover {
		opacity: 0.7;
	}
	nav {
		display: flex;
		align-items: center;
		justify-content: space-between;
		min-height: 4.5rem;
	}
	
	.menu-toggle {
		display: none;
		background: none;
		border: none;
		padding: 0.5em;
		cursor: pointer;
		color: var(--primary-foreground);
		transition: opacity 0.2s ease;
	}
	
	.menu-toggle:hover {
		opacity: 0.7;
	}
	
	.nav-content {
		display: flex;
		align-items: center;
		gap: 2em;
		flex: 1;
		justify-content: space-between;
		margin-left: 2em;
	}
	
	.internal-links {
		display: flex;
		align-items: center;
		gap: 0.5em;
	}
	
	nav a {
		padding: 1em 0.5em;
		color: var(--primary-foreground);
		border-bottom: 4px solid transparent;
		text-decoration: none;
		transition: border-bottom-color 0.2s ease, opacity 0.2s ease;
	}
	
	nav a:hover {
		border-bottom-color: oklch(from var(--primary) l c h / 0.3);
	}
	
	nav a.active {
		text-decoration: none;
		border-bottom-color: var(--primary);
	}
	
	nav a.active:hover {
		border-bottom-color: var(--primary);
	}
	
	
	/* モバイルスタイル */
	@media (max-width: 768px) {
		nav {
			min-height: 4.5rem;
		}
		
		.menu-toggle {
			display: block;
		}
		
		.nav-content {
			display: none;
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: var(--primary-background);
			box-shadow: var(--box-shadow);
			flex-direction: column;
			padding: 1em;
			gap: 1em;
			margin-left: 0;
			z-index: 1000;
		}
		
		.nav-content.is-open {
			display: flex;
		}
		
		
		.internal-links {
			flex-direction: column;
			width: 100%;
			gap: 0;
		}
		
		.internal-links a {
			width: 100%;
			padding: 0.75em 1em;
			border-bottom: 1px solid oklch(90% 0.01 262);
			border-left: 4px solid transparent;
			transition: background-color 0.2s ease, border-left-color 0.2s ease;
		}
		
		.internal-links a:hover {
			background: oklch(98% 0.005 262);
			border-left-color: oklch(from var(--primary) l c h / 0.3);
		}
		
		.internal-links a:last-child {
			border-bottom: none;
		}
		
		.internal-links a.active {
			border-left: 4px solid var(--primary);
			background: oklch(95% 0.01 262);
		}
		
		.internal-links a.active:hover {
			background: oklch(93% 0.01 262);
			border-left-color: var(--primary);
		}
		
		:global(.social-links) {
			width: 100%;
			justify-content: center;
			padding-top: 1em;
			border-top: 1px solid oklch(90% 0.01 262);
		}
	}
</style>
