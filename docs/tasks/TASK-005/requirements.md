# TASK-005: デバイス固有の問題対応 - 要件定義

## 1. 概要

### 1.1 目的
iPad、Androidタブレット、その他のタブレットデバイスで発生する固有の問題に対応し、すべてのデバイスで一貫した目次スクロール追従機能を実現する。

### 1.2 背景
- iPadのSplit View（分割画面）使用時に目次レイアウトが崩れる可能性がある
- Androidのマルチウィンドウモードで適切に動作しない可能性がある
- 画面向き変更時に目次の位置が不適切になることがある
- デバイス固有のスクロール動作による問題が発生する可能性がある

### 1.3 スコープ
- **対象**: デバイス固有の表示・動作問題
- **含む**: Split View対応、マルチウィンドウ対応、画面回転対応、タッチ操作最適化
- **含まない**: 新機能追加、デザイン変更、基本的な機能変更

## 2. 機能要件（EARS記法）

### 2.1 iPad Split View対応

#### REQ-501: Split View検出と対応
**WHEN** iPadでSplit Viewモードが有効になった時、
**THE SYSTEM SHALL** ビューポート幅を正確に検出し、適切なレイアウトモード（モバイル/タブレット/デスクトップ）を選択する。

#### REQ-502: Split View時のレイアウト維持
**WHILE** Split Viewモードが有効な間、
**THE SYSTEM SHALL** 目次の位置とサイズを動的に調整し、記事本文と適切な関係を維持する。

#### REQ-503: Split View切り替え時の滑らかな遷移
**IF** Split Viewのサイズが変更された場合、
**THEN THE SYSTEM SHALL** 目次の位置を滑らかにアニメーション遷移させる。

### 2.2 Androidマルチウィンドウ対応

#### REQ-504: マルチウィンドウ検出
**WHEN** Androidデバイスでマルチウィンドウモードが有効になった時、
**THE SYSTEM SHALL** ウィンドウサイズを正確に検出し、適切なレイアウトを適用する。

#### REQ-505: マルチウィンドウ時の表示制御
**IF** マルチウィンドウの幅が768px未満の場合、
**THEN THE SYSTEM SHALL** モバイルレイアウト（右下固定）を適用する。

#### REQ-506: フォーカス状態の管理
**WHILE** マルチウィンドウモードが有効な間、
**THE SYSTEM SHALL** アプリケーションのフォーカス状態に関わらず、目次の機能を維持する。

### 2.3 画面回転対応

#### REQ-507: 画面向き変更の検出
**WHEN** デバイスの画面向きが変更された時、
**THE SYSTEM SHALL** orientationchangeイベントを適切に処理し、新しい画面サイズを取得する。

#### REQ-508: 回転時の位置保持
**IF** 画面が回転した場合、
**THEN THE SYSTEM SHALL** ユーザーの現在の閲覧位置（スクロール位置）を維持する。

#### REQ-509: 回転後のレイアウト更新
**AFTER** 画面回転が完了した後、
**THE SYSTEM SHALL** 100ms以内に目次の位置とサイズを新しい画面サイズに合わせて更新する。

### 2.4 タッチ操作最適化

#### REQ-510: タッチスクロールの最適化
**WHEN** タッチデバイスでスクロール操作が行われた時、
**THE SYSTEM SHALL** passive: trueのイベントリスナーを使用し、スムーズなスクロールを実現する。

#### REQ-511: 慣性スクロールへの対応
**WHILE** 慣性スクロールが実行されている間、
**THE SYSTEM SHALL** 目次の位置更新を適切に遅延させ、パフォーマンスを維持する。

#### REQ-512: タップ領域の最適化
**WHERE** タッチデバイスが使用されている場合、
**THE SYSTEM SHALL** 目次のタップ可能領域を最小44x44pxに保つ。

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### NFR-501: デバイス固有処理のオーバーヘッド
デバイス固有の処理によるパフォーマンスオーバーヘッドは5%以下に抑える。

#### NFR-502: 画面回転時の応答速度
画面回転後、100ms以内にレイアウトの更新を完了する。

#### NFR-503: メモリ使用量
デバイス固有の処理によるメモリ増加は1MB以下に抑える。

### 3.2 互換性要件

#### NFR-504: iOS/iPadOS互換性
- iOS 15.0以上
- iPadOS 15.0以上
- Safari 15以上

#### NFR-505: Android互換性
- Android 9.0（API Level 28）以上
- Chrome for Android 100以上
- Samsung Internet 19.0以上

#### NFR-506: その他のタブレット
- Windows タブレット（Edge 100以上）
- Surface デバイス対応

### 3.3 ユーザビリティ要件

#### NFR-507: 視覚的フィードバック
デバイス固有のモード変更時に、適切な視覚的フィードバックを提供する。

#### NFR-508: エラー回復
デバイス固有の問題が発生した場合、自動的に回復し、基本機能を維持する。

## 4. 技術要件

### 4.1 検出方法

#### TECH-501: Split View検出
```javascript
// iPadのSplit View検出
const isSplitView = () => {
    const isIPad = /iPad/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    if (isIPad) {
        // Split Viewの判定（画面幅とwindow.innerWidthの差異を検出）
        return window.innerWidth < screen.width;
    }
    return false;
};
```

#### TECH-502: マルチウィンドウ検出
```javascript
// Androidマルチウィンドウ検出
const isMultiWindow = () => {
    // ビューポートとスクリーンサイズの比較
    const screenRatio = window.innerHeight / screen.height;
    return screenRatio < 0.9 && /Android/.test(navigator.userAgent);
};
```

#### TECH-503: 画面向き検出
```javascript
// 画面向き変更の検出と処理
const handleOrientationChange = () => {
    const orientation = window.orientation || 
                       screen.orientation?.angle || 0;
    const isLandscape = Math.abs(orientation) === 90;
    return { orientation, isLandscape };
};
```

### 4.2 実装戦略

#### TECH-504: Progressive Enhancement
基本機能を保証した上で、デバイス固有の拡張を追加する。

#### TECH-505: Feature Detection
User Agentではなく、機能検出を優先する。

#### TECH-506: Fallback Strategy
デバイス固有の機能が利用できない場合の代替実装を用意する。

## 5. 制約事項

### 5.1 技術的制約
- ブラウザAPIの制限により、一部のデバイス状態は正確に検出できない場合がある
- iOSのプライベートブラウジングモードでは一部の機能が制限される
- Androidの古いバージョンではマルチウィンドウAPIが利用できない

### 5.2 実装制約
- 既存のコードベースとの互換性を維持する
- パフォーマンス最適化（TASK-004）の成果を損なわない
- 追加のライブラリ導入は避ける

## 6. 受け入れ基準

### 6.1 iPad対応
- [ ] Split Viewの全サイズ（1/3、1/2、2/3）で正常動作
- [ ] Split View切り替え時にレイアウトが適切に更新される
- [ ] 画面回転時に目次が適切な位置に表示される

### 6.2 Android対応
- [ ] マルチウィンドウモードで正常動作
- [ ] Picture-in-Pictureモードでエラーが発生しない
- [ ] 各種Androidタブレットで動作確認済み

### 6.3 その他のデバイス
- [ ] Windowsタブレットで正常動作
- [ ] タッチ操作が最適化されている
- [ ] キーボード・マウス併用時も問題ない

### 6.4 パフォーマンス
- [ ] デバイス固有処理のオーバーヘッドが5%以下
- [ ] メモリリークが発生しない
- [ ] 60fpsを維持

## 7. リスクと緩和策

### 7.1 リスク
1. **デバイス検出の不正確さ**: User Agentの偽装や新しいデバイスへの対応
2. **パフォーマンス劣化**: デバイス固有処理による負荷増加
3. **将来の互換性**: OSアップデートによる動作変更

### 7.2 緩和策
1. **機能検出優先**: User Agentに依存しない実装
2. **条件付き実行**: 必要な場合のみデバイス固有処理を実行
3. **段階的拡張**: 基本機能を保証した上での拡張実装

## 8. 依存関係

### 8.1 前提条件
- TASK-004（パフォーマンス最適化）が完了していること
- 基本的な目次スクロール追従機能が動作していること

### 8.2 影響範囲
- TableOfContents.astroコンポーネント
- スクロールイベント処理
- リサイズイベント処理

## 9. 実装優先順位

1. **高優先度**
   - iPad Split View対応
   - 画面回転時の位置保持

2. **中優先度**
   - Androidマルチウィンドウ対応
   - タッチ操作最適化

3. **低優先度**
   - その他のタブレット対応
   - アニメーション遷移

## 10. 成功指標

### 10.1 定量的指標
- デバイス固有の問題報告が90%以上削減
- 全対象デバイスでの動作確認率100%
- パフォーマンススコアの維持（Lighthouse 95点以上）

### 10.2 定性的指標
- ユーザーからの肯定的フィードバック
- デバイス間での一貫した体験
- 直感的で自然な動作