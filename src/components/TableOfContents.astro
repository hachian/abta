---
import type { MarkdownHeading } from 'astro';

interface Props {
	headings?: MarkdownHeading[];
	heading?: NestedHeading;
}

interface NestedHeading extends MarkdownHeading {
	children: NestedHeading[];
}

const { headings = [] } = Astro.props;

// H2とH3のみを対象とする
const filteredHeadings = headings.filter(heading => heading.depth === 2 || heading.depth === 3);

// 見出しを階層構造に変換
function buildHierarchy(headings: MarkdownHeading[]): NestedHeading[] {
	const hierarchy: NestedHeading[] = [];
	const stack: NestedHeading[] = [];

	for (const heading of headings) {
		const nestedHeading: NestedHeading = { ...heading, children: [] };

		// 現在の見出しより深い階層をスタックから削除
		while (stack.length > 0 && stack[stack.length - 1].depth >= heading.depth) {
			stack.pop();
		}

		// 親が存在する場合は子として追加、そうでなければルートに追加
		if (stack.length === 0) {
			hierarchy.push(nestedHeading);
		} else {
			stack[stack.length - 1].children.push(nestedHeading);
		}

		stack.push(nestedHeading);
	}

	return hierarchy;
}

const nestedHeadings = buildHierarchy(filteredHeadings);

// 再帰コンポーネント用の型定義
const TableOfContentsHeading = Astro.self;
---

{nestedHeadings.length > 0 && (
	<nav class="table-of-contents" aria-label="目次" data-toc>
		<div class="toc-header">
			<h3 class="toc-title">目次</h3>
			<button 
				class="toc-toggle" 
				aria-expanded="true" 
				aria-controls="toc-list"
				data-toc-toggle
			>
				<span class="toc-toggle-icon"></span>
			</button>
		</div>
		<ul class="toc-list" id="toc-list" data-toc-list>
			{nestedHeadings.map((heading) => (
				<TableOfContentsHeading heading={heading} />
			))}
		</ul>
	</nav>
)}

{Astro.props.heading && Astro.props.heading.depth && (
	<li class={`toc-item toc-depth-${Astro.props.heading.depth}`}>
		<a 
			href={`#${Astro.props.heading.slug}`} 
			class="toc-link"
			data-toc-link={Astro.props.heading.slug}
		>
			{Astro.props.heading.text}
		</a>
		{Astro.props.heading.children && Astro.props.heading.children.length > 0 && (
			<ul class="toc-sublist">
				{Astro.props.heading.children.map((child: NestedHeading) => (
					<TableOfContentsHeading heading={child} />
				))}
			</ul>
		)}
	</li>
)}

<style>
	.table-of-contents {
		background: var(--primary-background);
		border-radius: 12px;
		box-shadow: var(--box-shadow);
		padding: 1.5rem;
		max-height: calc(100vh - 4rem);
		overflow-y: auto;
	}

	.toc-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 1rem;
		border-bottom: 1px solid oklch(90% 0.01 262);
		padding-bottom: 0.75rem;
	}

	.toc-title {
		margin: 0;
		font-size: 1.1rem;
		font-weight: 600;
		color: var(--primary-foreground);
	}

	.toc-toggle {
		display: none;
		background: none;
		border: none;
		cursor: pointer;
		padding: 0.5rem;
		border-radius: 4px;
		transition: background-color 0.2s ease;
	}

	.toc-toggle:hover {
		background: oklch(92% 0.01 262);
	}

	.toc-toggle-icon {
		display: block;
		width: 1rem;
		height: 1rem;
		position: relative;
	}

	.toc-toggle-icon::before,
	.toc-toggle-icon::after {
		content: '';
		position: absolute;
		left: 50%;
		top: 50%;
		width: 12px;
		height: 2px;
		background: var(--primary-foreground);
		border-radius: 1px;
		transition: transform 0.2s ease;
	}

	.toc-toggle-icon::before {
		transform: translate(-50%, -50%) rotate(0deg);
	}

	.toc-toggle-icon::after {
		transform: translate(-50%, -50%) rotate(90deg);
	}

	/* 折りたたんでいるとき（aria-expanded="false"）はプラス（+）を表示 */
	.toc-toggle[aria-expanded="false"] .toc-toggle-icon::after {
		transform: translate(-50%, -50%) rotate(90deg);
	}

	/* 開いているとき（aria-expanded="true"）はマイナス（-）を表示 */
	.toc-toggle[aria-expanded="true"] .toc-toggle-icon::after {
		transform: translate(-50%, -50%) rotate(0deg);
	}

	.toc-list {
		list-style: none;
		margin: 0;
		padding: 0;
		position: relative;
	}

	.toc-sublist {
		list-style: none;
		margin: 0.25rem 0 0 0;
		padding: 0;
		position: relative;
	}

	.toc-item {
		margin-bottom: 0.3rem;
		position: relative;
	}

	.toc-sublist .toc-item {
		margin-bottom: 0.2rem;
	}

	.toc-item:last-child {
		margin-bottom: 0;
	}

	/* 縦線の表示 */
	.toc-list::before {
		content: '';
		position: absolute;
		left: 4px;
		top: calc(0.5em + 12px);
		bottom: calc(0.5em + 12px);
		width: 1px;
		background: oklch(85% 0.02 262);
		z-index: 0;
	}


	.toc-link {
		display: flex;
		align-items: center;
		color: var(--primary-foreground);
		text-decoration: none;
		padding: 0.25rem 0 0.25rem 1rem;
		font-size: 0.875rem;
		line-height: 1.5;
		transition: all 0.2s ease;
		position: relative;
	}

	.toc-link::before {
		content: '';
		border-radius: 50%;
		flex-shrink: 0;
		transition: background-color 0.2s ease;
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		z-index: 1;
	}

	.toc-link:hover {
		color: var(--primary);
	}

	.toc-link.active {
		color: var(--primary);
		font-weight: 500;
	}


	/* H2の丸（大・青） */
	.toc-depth-2 > .toc-link::before {
		width: 8px;
		height: 8px;
		background: var(--primary);
		left: 0px;
	}

	/* H3の丸（小・薄い青） */
	.toc-depth-3 > .toc-link::before {
		width: 4px;
		height: 4px;
		background: var(--primary-light);
		left: 2px;
	}

	/* タブレット・デスクトップ対応（目次は固定のまま） */
	@media (min-width: 768px) {
		.toc-toggle {
			display: none;
		}
	}

	/* タブレット専用調整 */
	@media (min-width: 768px) and (max-width: 1279px) {
		.table-of-contents {
			padding: 1.25rem; /* 1.5rem → 1.25rem */
			font-size: 0.875rem; /* 14px */
		}
		
		.toc-title {
			font-size: 1rem; /* 1.1rem → 1rem */
		}
		
		.toc-link {
			padding: 0.2rem 0 0.2rem 0.875rem; /* 少しコンパクトに */
			font-size: 0.8125rem; /* 13px */
		}
		
		/* タブレットでの縦線調整 */
		.toc-list::before {
			left: 3px; /* 4px → 3px */
		}
		
		/* タブレットでの丸印調整 */
		.toc-depth-2 > .toc-link::before {
			width: 7px; /* 8px → 7px */
			height: 7px;
			left: -1px;
		}
		
		.toc-depth-3 > .toc-link::before {
			width: 3px; /* 4px → 3px */
			height: 3px;
			left: 1px;
		}
	}

	/* モバイル対応（右下固定表示） */
	@media (max-width: 767px) {
		.table-of-contents {
			position: fixed;
			bottom: 1rem;
			right: 1rem;
			top: auto;
			max-height: 70vh;
			width: min(280px, calc(100vw - 2rem));
			z-index: 1000;
			margin-bottom: 0;
			padding: 1rem;
			box-shadow: 0 4px 20px oklch(12% 0.02 262 / 0.3);
		}

		.toc-toggle {
			display: block;
		}

		.toc-list[data-collapsed="true"] {
			display: none;
		}

		.toc-title {
			font-size: 1rem;
		}

		.toc-link {
			font-size: 0.8rem;
		}

		/* 初期状態で折りたたみ */
		.toc-list {
			max-height: 300px;
			overflow-y: auto;
		}
	}
</style>

<script>
	// 目次の折りたたみ機能と階層構造の初期化
	function initTableOfContents() {
		const toggleButton = document.querySelector('[data-toc-toggle]') as HTMLButtonElement;
		const tocList = document.querySelector('[data-toc-list]') as HTMLElement;

		if (!toggleButton || !tocList) return;

		// 子項目がある親項目にクラスを追加
		const parentItems = document.querySelectorAll('.toc-depth-2');
		parentItems.forEach(item => {
			const sublist = item.querySelector('.toc-sublist');
			if (sublist && sublist.children.length > 0) {
				item.classList.add('has-children');
			}
		});

		toggleButton.addEventListener('click', () => {
			const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
			toggleButton.setAttribute('aria-expanded', String(!isExpanded));
			tocList.setAttribute('data-collapsed', String(isExpanded));
		});

		// モバイルでは初期状態で折りたたみ
		const isMobile = window.innerWidth <= 767;
		if (isMobile) {
			toggleButton.setAttribute('aria-expanded', 'false');
			tocList.setAttribute('data-collapsed', 'true');
		}

		// リサイズ時の対応
		window.addEventListener('resize', () => {
			const isCurrentlyMobile = window.innerWidth <= 767;
			if (isCurrentlyMobile) {
				toggleButton.setAttribute('aria-expanded', 'false');
				tocList.setAttribute('data-collapsed', 'true');
			} else {
				toggleButton.setAttribute('aria-expanded', 'true');
				tocList.setAttribute('data-collapsed', 'false');
			}
		});
	}

	// アクティブ見出し追跡機能
	function initActiveHeadingTracking() {
		const tocLinks = document.querySelectorAll('[data-toc-link]') as NodeListOf<HTMLAnchorElement>;
		const headings = Array.from(tocLinks).map(link => {
			const slug = link.getAttribute('data-toc-link');
			return document.getElementById(slug || '');
		}).filter(Boolean) as HTMLElement[];

		if (headings.length === 0) return;

		function updateActiveHeading() {
			const scrollTop = window.scrollY + 100; // 100pxのオフセット
			let activeHeading: HTMLElement | null = null;

			// 現在のスクロール位置より上にある最後の見出しを見つける
			for (let i = headings.length - 1; i >= 0; i--) {
				const heading = headings[i];
				if (heading.offsetTop <= scrollTop) {
					activeHeading = heading;
					break;
				}
			}

			// 見つからない場合は最初の見出しをアクティブにする
			if (!activeHeading && headings.length > 0) {
				activeHeading = headings[0];
			}

			// 全てのリンクからactiveクラスを削除
			tocLinks.forEach(link => link.classList.remove('active'));

			// アクティブな見出しのリンクにactiveクラスを追加
			if (activeHeading) {
				const activeLink = document.querySelector(`[data-toc-link="${activeHeading.id}"]`);
				activeLink?.classList.add('active');
			}
		}

		// 初期実行
		updateActiveHeading();

		// スクロールイベントでリアルタイム更新
		let ticking = false;
		function onScroll() {
			if (!ticking) {
				requestAnimationFrame(() => {
					updateActiveHeading();
					ticking = false;
				});
				ticking = true;
			}
		}

		window.addEventListener('scroll', onScroll);
	}

	// スムーズスクロール
	function initSmoothScroll() {
		const tocLinks = document.querySelectorAll('[data-toc-link]') as NodeListOf<HTMLAnchorElement>;
		
		tocLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const targetId = link.getAttribute('data-toc-link');
				const targetElement = document.getElementById(targetId || '');
				
				if (targetElement) {
					targetElement.scrollIntoView({
						behavior: 'smooth',
						block: 'start'
					});
				}
			});
		});
	}

	// スクロール追従機能
	function initScrollFollowing() {
		// 軽量エラー状態管理
		let tocMode = 0; // 0=normal, 1=fallback, 2=disabled
		
		// パフォーマンス設定
		const PERFORMANCE_CONFIG = {
			BREAKPOINTS: {
				MOBILE_MAX: 767,
				TABLET_MIN: 768,
				TABLET_MAX: 1279,
				DESKTOP_MIN: 1280
			},
			MARGINS: {
				TABLET: 24,    // 1.5rem
				DESKTOP: 32    // 2rem
			},
			THRESHOLDS: {
				TOC_MAX_WIDTH: 240,  // 15rem
				HEADER_HEIGHT: 72
			}
		};
		
		// デバイス検出システム
		const DeviceDetector = {
			// iPad検出（iOS 13以降も対応）
			isIPad(): boolean {
				return /iPad/.test(navigator.userAgent) || 
				       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
			},
			
			// Split View検出
			isSplitView(): boolean {
				if (!this.isIPad()) return false;
				// Split Viewでは画面幅が物理画面幅より小さくなる
				return window.innerWidth < screen.width;
			},
			
			// Androidデバイス検出
			isAndroid(): boolean {
				return /Android/.test(navigator.userAgent);
			},
			
			// マルチウィンドウ検出（Android）
			isMultiWindow(): boolean {
				if (!this.isAndroid()) return false;
				const heightRatio = window.innerHeight / screen.height;
				return heightRatio < 0.9;
			},
			
			// タッチデバイス検出
			isTouchDevice(): boolean {
				return 'ontouchstart' in window || 
				       navigator.maxTouchPoints > 0;
			},
			
			// 適切なレイアウトモードを取得
			getLayoutMode(width: number): 'mobile' | 'tablet' | 'desktop' {
				// Split ViewやマルチウィンドウでモバイルレイアウトにすべきiPad/Android
				if (this.isSplitView() && width < 768) {
					return 'mobile';
				}
				if (this.isMultiWindow() && width < 768) {
					return 'mobile';
				}
				
				// 通常の判定
				if (width <= 767) return 'mobile';
				if (width <= 1279) return 'tablet';
				return 'desktop';
			}
		};
		
		// 画面回転ハンドラー
		const OrientationHandler = {
			lastScrollY: 0,
			lastActiveElement: null as Element | null,
			
			// 初期化
			init(updateCallback: Function) {
				// 画面回転イベントのリスナー登録
				if ('orientation' in window) {
					window.addEventListener('orientationchange', () => {
						this.handleOrientationChange(updateCallback);
					});
				}
				
				// 代替: リサイズイベントで画面向き変更を検出
				let lastOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
				window.addEventListener('resize', () => {
					const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
					if (currentOrientation !== lastOrientation) {
						lastOrientation = currentOrientation;
						this.handleOrientationChange(updateCallback);
					}
				}, { passive: true });
			},
			
			// 画面回転時の処理
			handleOrientationChange(updateCallback: Function) {
				// 現在のスクロール位置とアクティブ要素を保存
				this.preserveState();
				
				// 回転完了を待つ（iOS/Androidの違いを吸収）
				setTimeout(() => {
					updateCallback();
					this.restoreState();
				}, 100);
			},
			
			// 状態の保存
			preserveState() {
				this.lastScrollY = window.scrollY;
				const activeHeading = document.querySelector('.toc-link.active');
				if (activeHeading) {
					const targetId = activeHeading.getAttribute('data-toc-link');
					this.lastActiveElement = document.getElementById(targetId || '');
				}
			},
			
			// 状態の復元
			restoreState() {
				if (this.lastActiveElement) {
					this.lastActiveElement.scrollIntoView({ block: 'start' });
					window.scrollBy(0, -100);
				} else {
					window.scrollTo(0, this.lastScrollY);
				}
			}
		};
		
		// 軽量DOM検証（必要最小限）
		const tocSidebar = document.getElementById('toc-sidebar');
		const mainArticle = document.querySelector('.main-article');
		const proseElement = mainArticle?.querySelector('.prose');
		
		if (!tocSidebar || !mainArticle || !proseElement) {
			return; // 軽量終了
		}

		// レイアウトモードの判定
		const layoutMode = DeviceDetector.getLayoutMode(window.innerWidth);
		let ticking = false;
		let articleRect: DOMRect | null = null;
		
		// モバイルの場合は早期終了
		if (layoutMode === 'mobile') return;
		
		// 短い記事チェック（軽量）
		if (mainArticle.offsetHeight < window.innerHeight * 0.5) {
			return;
		}
		
		// 見出し存在チェック（軽量）
		if (document.querySelectorAll('[data-toc-link]').length === 0) {
			return;
		}
		
		// 横方向位置キャッシュ
		let fixedHorizontalPosition = null;
		
		// 軽量ビューポートキャッシュ
		const viewportCache = {
			width: window.innerWidth,
			layoutMode: layoutMode,
			isSplitView: DeviceDetector.isSplitView(),
			isMultiWindow: DeviceDetector.isMultiWindow(),
			
			get isTablet() { 
				return this.layoutMode === 'tablet';
			},
			
			update() {
				const newWidth = window.innerWidth;
				const newLayoutMode = DeviceDetector.getLayoutMode(newWidth);
				
				if (newWidth !== this.width || newLayoutMode !== this.layoutMode) {
					this.width = newWidth;
					this.layoutMode = newLayoutMode;
					this.isSplitView = DeviceDetector.isSplitView();
					this.isMultiWindow = DeviceDetector.isMultiWindow();
					return true;
				}
				return false;
			}
		};

		// 記事要素の位置を取得・更新（軽量版）
		function updateArticlePosition() {
			if (mainArticle) {
				try {
					articleRect = mainArticle.getBoundingClientRect();
				} catch {
					articleRect = null;
				}
			}
		}
		
		// 横方向位置を計算（軽量版）
		function calculateHorizontalPosition() {
			if (!articleRect?.right) return null;
			
			const margins = viewportCache.isTablet ? 
				PERFORMANCE_CONFIG.MARGINS.TABLET : 
				PERFORMANCE_CONFIG.MARGINS.DESKTOP;
				
			// Split View時の調整
			const gap = viewportCache.isSplitView ? 
				(viewportCache.isTablet ? 16 : 24) : margins;
			
			const leftPosition = articleRect.right + gap;
			
			// 右端チェック
			const tocWidth = tocSidebar?.offsetWidth || 240;
			const rightMargin = viewportCache.isTablet ? 
				PERFORMANCE_CONFIG.MARGINS.TABLET : 
				PERFORMANCE_CONFIG.MARGINS.DESKTOP * 1.5;
			const maxLeft = viewportCache.width - tocWidth - rightMargin;
			
			return leftPosition > maxLeft ? maxLeft : leftPosition;
		}

		// 目次の位置を更新（軽量版）
		function updateTocPosition() {
			if (tocMode === 2 || viewportCache.layoutMode === 'mobile') return;
			
			if (!proseElement || !tocSidebar) {
				tocMode = 2;
				return;
			}
			
			try {
				// 横方向位置計算
				if (fixedHorizontalPosition === null) {
					fixedHorizontalPosition = calculateHorizontalPosition();
				}
				
				if (fixedHorizontalPosition === null) return;
				
				const scrollY = window.scrollY || 0;
				const proseRect = proseElement.getBoundingClientRect();
				
				if (!proseRect) return;
				
				const proseTop = proseRect.top + scrollY;
				
				// スタイル設定（バッチ処理）
				const topMargin = viewportCache.isTablet ? 24 : 32;
				const baseTop = scrollY > 72 ? topMargin : 72 + topMargin;
				const tocTop = Math.max(baseTop, proseTop - scrollY);
				const maxHeight = window.innerHeight - tocTop - topMargin;
				
				Object.assign(tocSidebar.style, {
					position: 'fixed',
					left: `${fixedHorizontalPosition}px`,
					top: `${tocTop}px`,
					maxHeight: `${maxHeight}px`,
					visibility: 'visible',
					opacity: '1'
				});
				
			} catch {
				tocMode = 1; // フォールバックモード
			}
		}
		
		// 目次の完全再配置（軽量版）
		function repositionToc() {
			fixedHorizontalPosition = null; // リセットして再計算
			
			// 幅制限
			if (tocSidebar) {
				if (viewportCache.isTablet) {
					const tocWidth = tocSidebar.offsetWidth || 240;
					const maxTocWidth = Math.min(tocWidth, 240);
					tocSidebar.style.width = `${maxTocWidth}px`;
				} else if (viewportCache.isMultiWindow) {
					const tocWidth = tocSidebar.offsetWidth || 200;
					const maxTocWidth = Math.min(tocWidth, 200);
					tocSidebar.style.width = `${maxTocWidth}px`;
				} else {
					tocSidebar.style.width = '';
				}
			}
			
			updateTocPosition();
		}

		// スクロールイベントハンドラ（軽量版）
		function onScroll() {
			if (!ticking) {
				requestAnimationFrame(() => {
					if (tocMode < 2) {
						updateTocPosition();
					}
					ticking = false;
				});
				ticking = true;
			}
		}

		// リサイズイベントハンドラ（軽量版）
		function onResize() {
			const oldLayoutMode = viewportCache.layoutMode;
			const hasChanged = viewportCache.update();
			
			if (hasChanged) {
				if (oldLayoutMode !== viewportCache.layoutMode) {
					// レイアウトモード変更
					if (viewportCache.layoutMode === 'mobile') {
						// モバイル切り替え: スタイルクリア
						if (tocSidebar) {
							Object.assign(tocSidebar.style, {
								position: '',
								left: '',
								top: '',
								width: '',
								maxHeight: ''
							});
						}
					} else if (oldLayoutMode === 'mobile') {
						// モバイルから復帰: 再初期化
						updateArticlePosition();
						repositionToc();
					}
				} else {
					// 同一モード内リサイズ
					updateArticlePosition();
					repositionToc();
				}
			}
		}

		// 初期実行
		updateArticlePosition();
		repositionToc();

		// 画面回転ハンドラーの初期化（軽量版）
		OrientationHandler.init(() => {
			const hasChanged = viewportCache.update();
			if (hasChanged) {
				updateArticlePosition();
				repositionToc();
			}
		});
		
		// タッチデバイス最適化
		if (DeviceDetector.isTouchDevice()) {
			// タップ領域を拡大
			const tocLinks = document.querySelectorAll('.toc-link');
			tocLinks.forEach(link => {
				(link as HTMLElement).style.minHeight = '44px';
				(link as HTMLElement).style.paddingTop = '10px';
				(link as HTMLElement).style.paddingBottom = '10px';
			});
			
			// 慣性スクロール対応
			let isScrolling = false;
			let scrollTimeout: number;
			
			window.addEventListener('scroll', () => {
				if (!isScrolling && tocSidebar) {
					isScrolling = true;
					tocSidebar.style.pointerEvents = 'none';
				}
				
				clearTimeout(scrollTimeout);
				scrollTimeout = window.setTimeout(() => {
					isScrolling = false;
					if (tocSidebar) {
						tocSidebar.style.pointerEvents = 'auto';
					}
				}, 150);
			}, { passive: true });
		}
		
		// イベントリスナー設定（passive: true でパフォーマンス最適化）
		window.addEventListener('scroll', onScroll, { passive: true });
		window.addEventListener('resize', onResize, { passive: true });

		// クリーンアップ
		return () => {
			window.removeEventListener('scroll', onScroll);
			window.removeEventListener('resize', onResize);
		};
	}

	// ページ読み込み時とナビゲーション時に実行
	document.addEventListener('DOMContentLoaded', () => {
		initTableOfContents();
		initActiveHeadingTracking();
		initSmoothScroll();
		initScrollFollowing();
	});

	// Astroのナビゲーション後にも実行
	document.addEventListener('astro:page-load', () => {
		initTableOfContents();
		initActiveHeadingTracking();
		initSmoothScroll();
		initScrollFollowing();
	});
</script>