---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const allTags = [...new Set(posts.flatMap(post => post.data.tags || []))];
  
  return allTags.map(tag => ({
    params: { tag },
    props: { 
      posts: posts.filter(post => post.data.tags?.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    }
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Posts tagged "${tag}" - ${SITE_TITLE}`} description={`Posts tagged with ${tag}`} />
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
			}
			.page-header {
				text-align: center;
				margin-bottom: 2rem;
			}
			.tag-badge {
				display: inline-block;
				background: var(--primary-dark);
				color: var(--white);
				padding: 0.5rem 1rem;
				border-radius: 20px;
				font-size: 0.9rem;
				margin-bottom: 1rem;
			}
			.posts-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 2rem;
				margin-top: 2rem;
			}
			.post-card {
				background: var(--secondary-light);
				border-radius: 8px;
				padding: 1.5rem;
				text-decoration: none;
				color: var(--black);
				transition: all 0.2s ease;
				border: 1px solid var(--secondary-light);
			}
			.post-card:hover {
				background: var(--secondary-lighter);
				border-color: var(--accent);
				transform: translateY(-2px);
			}
			.post-image {
				width: 100%;
				height: 200px;
				object-fit: cover;
				border-radius: 4px;
				margin-bottom: 1rem;
			}
			.post-title {
				font-size: 1.2rem;
				font-weight: bold;
				margin-bottom: 0.5rem;
				line-height: 1.3;
			}
			.post-description {
				color: var(--secondary);
				font-size: 0.9rem;
				margin-bottom: 1rem;
			}
			.post-date {
				color: var(--secondary);
				font-size: 0.8rem;
			}
			.back-link {
				color: var(--accent);
				text-decoration: none;
				margin-bottom: 1rem;
				display: inline-block;
			}
			.back-link:hover {
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<a href="/tags/" class="back-link">‚Üê Back to all tags</a>
			<div class="page-header">
				<div class="tag-badge">{tag}</div>
				<h1>Posts tagged "{tag}"</h1>
				<p>{posts.length} {posts.length === 1 ? 'post' : 'posts'}</p>
			</div>
			<div class="posts-grid">
				{posts.map(post => (
					<a href={`/blog/${post.id.replace('/index', '')}/`} class="post-card">
						{post.data.heroImage && (
							<Image 
								src={post.data.heroImage} 
								alt="" 
								width={300} 
								height={200} 
								class="post-image"
							/>
						)}
						<div class="post-title">{post.data.title}</div>
						<div class="post-description">{post.data.description}</div>
						<div class="post-date">
							<FormattedDate date={post.data.pubDate} />
						</div>
					</a>
				))}
			</div>
		</main>
		<Footer />
	</body>
</html>